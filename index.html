<!-- Virtua browser REPL.
     Copyright (c) 2012 Manuel Simoni. See license at end of file. -->
<html>
<head>
  <title>Virtua 0.1.0</title>
  <script src="jsparse.js" type="text/javascript"></script>
  <script src="virtua.js" type="text/javascript"></script>
  <script src="test.js" type="text/javascript"></script>
</head>
<body onload="lisp_repl_load()">
  <div style="float: right"><a href="doc/manual.html">Manual</a></div>
  <div id="output">
  </div>
  <form id="evalform"
        onsubmit="try{lisp_repl_eval(lisp_parse(document.forms.evalform.input.value))}finally{return false}">
    <input type="text" name="input">
    <input type="submit" value="eval">
  </form>
  <script type="text/javascript">
var lisp_core_env;

function lisp_repl_load() {
    lisp_core_env = lisp_make_core_environment();
    lisp_environment_put_comfortably(lisp_core_env, "print", lisp_wrap_native(lisp_repl_print));

    lisp_repl_eval(lisp_parse(lisp_get_file("standard.virtua")));

    lisp_repl_print(lisp_make_string("LISP READY"));
}

function lisp_repl_eval(forms) {
    lisp_repl_print(lisp_make_string("> " + document.forms.evalform.input.value));
    for (var i = 0; i < forms.length; i++) {
        var form = forms[i];
        var result;
        try {
            result = lisp_eval(form, lisp_core_env);
        } catch(e) {
            result = lisp_make_string("ERROR: " + e);
        }
        if (result !== lisp_inert) {
            lisp_repl_print(result);
        }
    }
    return false;
}

function lisp_repl_print(obj) {
    var resultDiv = document.createElement("div");
    resultDiv.appendChild(document.createTextNode(lisp_string_native_string(lisp_send(obj, "to-string", lisp_nil))));
    var output = document.getElementById("output");
    output.appendChild(resultDiv);
    document.forms.evalform.input.value = "";
    return lisp_inert;
}

function lisp_get_file(path) {
    var req = new XMLHttpRequest();
    // Append random thang to file path to bypass browser cache.
    req.open("GET", path + "?" + Math.random(), false);
    req.send(null);
    if(req.status == 200) {
        return req.responseText;
    } else {
        lisp_simple_error("XHR error: " + req.status);
    }
}

  </script>
</body>
</html>


<!--
// Permission is hereby granted, free of charge, to any person
// obtaining a copy of this software and associated documentation
// files (the "Software"), to deal in the Software without
// restriction, including without limitation the rights to use, copy,
// modify, merge, publish, distribute, sublicense, and/or sell copies
// of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be
// included in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
// NONINFRINGEMENT. REMEMBER, THERE IS NO KERNEL UNDERGROUND; IT'S ALL
// JUST RUMOUR AND HEARSAY. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
// HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
// WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.
-->
